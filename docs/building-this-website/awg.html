<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <meta name="generator" content="HTML Tidy for HTML5 for Apple macOS version 5.8.0" />
    <meta charset="utf-8" />
    <meta http-equiv="Referrer-Policy" content="no-referrer" />
    <meta http-equiv="X-Content-Type-Options" content="nosniff" />
    <meta http-equiv="Upgrade-Insecure-Requests" content="1" />
    <meta http-equiv="Strict-Transport-Security" content="max-age=63072000; includeSubDomains" />
    <meta http-equiv="Content-Security-Policy" content=
    "upgrade-insecure-requests; default-src 'none'; require-trusted-types-for 'script'; base-uri 'self'; img-src 'self'; manifest-src 'self'; script-src-elem 'strict-dynamic' 'sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6' 'sha384-F/bZzf7p3Joyp5psL90p/p89AZJsndkSoGwRpXcZhleCWhd8SnRuoYo4d0yirjJp' 'sha384-nq/jJqKHx2Beq2PLdLsH/0zMwhVN8i9yl8mm8MikpU3k2nTuAJIWXQdIKTyhGQ0w' 'sha384-H2o0JdK+a6Nv0Bq7U4BlXJ36aFpF5pw1X/JWhzWBYGGNZQQVFqBTD9hUrk0IuIIS' 'sha384-Yfa985Z0LorjBya15TjALqmYYUOLsdk67u37ToLE+xJAfmJ8G78yGxNkv4zPJsBI' ; connect-src 'self' ; font-src 'self' https://cdn.jsdelivr.net ; style-src 'self' https://cdn.jsdelivr.net 'sha384-tl5h4XuWmVzPeVWU0x8bx0j/5iMwCBduLEgZ+2lH4Wjda+4+q3mpCww74dgAB3OX' 'sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP' 'sha384-vpayKGwduWhgY00faoPtbmJwz8TjOLnnDuqvy+xWy2DWuIVxIt0dxj0mjrMVPxdd' 'sha384-6tuxMr6N8BYhY1MziAiDxbBp7gb26fGRPr8qQoxo6b6wrAZ15oleECL9OBf2NJjk' ;" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Timothy Corbett-Clark" />
    <meta name="description" content="Personal website of Dr Timothy Corbett-Clark" />
    <title>
      Dr Timothy Corbett-Clark
    </title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css"
    integrity="sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP" crossorigin="anonymous" />
    <link rel="stylesheet" type="text/css" href=
    "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/base16/gruvbox-light-hard.min.css"
    integrity="sha384-vpayKGwduWhgY00faoPtbmJwz8TjOLnnDuqvy+xWy2DWuIVxIt0dxj0mjrMVPxdd" crossorigin="anonymous" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css" integrity=
    "sha384-tl5h4XuWmVzPeVWU0x8bx0j/5iMwCBduLEgZ+2lH4Wjda+4+q3mpCww74dgAB3OX" crossorigin="anonymous" />
    <link rel="stylesheet" type="text/css" href="/fontawesome/css/fontawesome.min.css" integrity=
    "sha384-AGSGRaBRodcsy1n0F2zMm+LfXuZry/ZJ6nfio36UgMuNBs/AOC8ciJ7py4SgkpoY" />
    <link rel="stylesheet" type="text/css" href="/fontawesome/css/brands.min.css" integrity=
    "sha384-CNhPUG5cpX8UuKLY0BCb+gzedmWkhHPKATz919jTKgOXajXjkEY99Qr51B5V2wOQ" />
    <link rel="stylesheet" type="text/css" href="/fontawesome/css/regular.min.css" integrity=
    "sha384-6Zsk745fBctG7JVrpWegJSSYk7xb3Zjy7CNEEG3dFcFGiTU/ti4muXgYnTZ6nYys" />
    <link rel="stylesheet" type="text/css" href="/fontawesome/css/solid.min.css" integrity=
    "sha384-H/BU8KfYKZ0VK4RJyclToSd6x8TmMY4/Rym2YtHXnGQOUZAoLIYIaOxkIfyTAuVh" />
    <link rel="stylesheet" type="text/css" href="/main.css" integrity=
    "sha384-6tuxMr6N8BYhY1MziAiDxbBp7gb26fGRPr8qQoxo6b6wrAZ15oleECL9OBf2NJjk" />
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js" integrity=
    "sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6" crossorigin="anonymous"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"
    integrity="sha384-F/bZzf7p3Joyp5psL90p/p89AZJsndkSoGwRpXcZhleCWhd8SnRuoYo4d0yirjJp" crossorigin=
    "anonymous"></script>
    <script defer="defer" src="/hot-reloader.js" integrity=
    "sha384-nq/jJqKHx2Beq2PLdLsH/0zMwhVN8i9yl8mm8MikpU3k2nTuAJIWXQdIKTyhGQ0w"></script>
    <script defer="defer" src="/render-maths.js" integrity=
    "sha384-H2o0JdK+a6Nv0Bq7U4BlXJ36aFpF5pw1X/JWhzWBYGGNZQQVFqBTD9hUrk0IuIIS"></script>
    <script defer="defer" src="/render-code.js" integrity=
    "sha384-Yfa985Z0LorjBya15TjALqmYYUOLsdk67u37ToLE+xJAfmJ8G78yGxNkv4zPJsBI"></script>
  </head>
  <body>
    <header class="hero is-small is-primary">
      <div class="hero-body">
        <p class="title">
          Dr Timothy Corbett‑Clark
        </p>
        <p class="subtitle">
          CTO, Researcher, Developer
        </p>
      </div>
    </header>
    <section class="section pb-3 pt-3 has-background-primary-bold-invert has-text-primary-bold">
      <nav class="level">
        <div class="level-left">
          <div class="level-item">
            <span class="tag"><a href="/welcome/index.html"><i class="fa-solid fa-home"></i> Home</a></span>
          </div>
          <div class="level-item">
            <span class="tag"><a href="index.html"><i class="fa-solid fa-arrow-left"></i> Back to: Building this
            website</a></span>
          </div>
        </div>
      </nav>
    </section>
    <section class="section pt-0 has-background-primary-bold-invert has-text-primary-bold">
      <div class="box">
        <div class="title is-size-2 has-text-centered">
          Agnostic Website Generator - AWG
        </div>
        <div class="content">
          <h1>
            Introduction
          </h1>
          <p>
            Assuming a willingness to understand the necessary web technologies, why not create static websites <em>by
            hand</em>? The main problems are around inefficient repetition and cumbersome syntax. For example,
          </p>
          <ul>
            <li>copy-and-paste maintenance of the same content e.g. in headers and footers;
            </li>
            <li>copy-and-paste maintenance of the same formatting/styling tags around repeated lists of things;
            </li>
            <li>using a verbose syntax like HTML when wanting to focus purely on content.
            </li>
          </ul>
          <p>
            These pain points can be ameliorated by using a markup language (like <a href=
            "https://commonmark.org">markdown</a>), templating (e.g. with <a href=
            "https://jinja.palletsprojects.com">Jinja</a>), and writing data/metadata in a data-oriented syntax (such
            as <a href="https://toml.io/">TOML</a>).
          </p>
          <h2>
            Features / anti-features
          </h2>
          <p>
            My tool makes it easier to create a static website of the usual HTML, CSS, and Javascript files (plus a few
            others such as the manifest.json, robots.txt, and sitemap.xml). <strong>It is a scaffolding tool with no
            fundamental opinion about these web files</strong>.
          </p>
          <p>
            The essential features are:
          </p>
          <ol>
            <li>Converting Markdown into HTML (to allow content to be written more easily).
            </li>
            <li>Templating using Jinja (most obviously to make it easier to produce repetative HTML).
            </li>
            <li>Reading template data from TOML files (to pass to Jinja).
            </li>
            <li>Validating and prettifying all final HTML by running through <a href="http://html-tidy.org">HTML
            tidy</a> (if available).
            </li>
          </ol>
          <p>
            Then, to create a fast iterative loop:
          </p>
          <ol start="5">
            <li>Serving up content on a local http(s) webserver (for review during development).
            </li>
            <li>Watching for source file changes and rebuilding automatically.
            </li>
            <li>Notifying browser(s) of new builds (e.g. to trigger a “hot reload”).
            </li>
          </ol>
          <p>
            Note the absence of themes, plugins, blog posts, tags, articles, Atom or RSS feeds etc. Many of these are
            easy to achieve using the tool’s machinery without explicit native support.
          </p>
          <h2>
            Zero config
          </h2>
          <p>
            With the exception of a few command line options to tell the tool where to find the content and put the
            output, <strong>there is no configuration</strong>. There are no required files or directory structures,
            and so (degenerately) <strong>the tool will run fine on an empty directory</strong>. There is a simple
            <code>example/</code> content directory in the <a href=
            "https://github.com/tcorbettclark/tcorbettclark.github.io">GitHub repository</a> to demo some of the
            functionality and provide a learning sandpit to play in.
          </p>
          <h2>
            Subtractive approach
          </h2>
          <p>
            Instead of copying and creating files and directories from various sources and processes, the tool takes a
            “subtractive” approach. The build process starts by cloning a given content directory into a new output
            directory. After running the build process, all “working files” are deleted from this output directory. By
            default,
          </p>
          <ul>
            <li>
              <em>working files</em> are identified as filenames starting with an underscore, and
            </li>
            <li>
              <em>template files</em> are identified as <em>not</em> being a working file and having an extension of
              <code>.html</code>, <code>.xml</code>, and <code>.txt</code>.
            </li>
          </ul>
          <p>
            In addition to removing mystery around how an output is generated, this approach allows maintenance effort
            to be reduced by grouping related content. For example, all HTML, Markdown, template data, Javascript, etc
            relating to a particular page or section of the site <strong>can be kept together in the same
            directory</strong>. This localisation of content means that after changes, removal, or replacement, the
            chances of things being left behind afterwards are much reduced.
          </p>
          <p>
            Note however that due to the tool’s lack of opinion in this regard, content can still be grouped by type in
            the traditional fashion if desired (all the javascript in one directory, all the CSS in another, etc). Or a
            mixed by-purpose/by-type strategy used. Regardless, the files and structure is all explicit and visible.
          </p>
          <h2>
            Templating and template data
          </h2>
          <p>
            To provide templating, AWG uses <a href="https://jinja.palletsprojects.com">Jinja</a>, a popular and mature
            templating library.
          </p>
          <p>
            Jinja uses absolute file paths, which makes it harder to maintain source directory structure (e.g. renaming
            directories), and discourages “by-purpose” organisation of the files. Hence AWG overrides the Jinja
            environment so that including or extending other files is <em>relative to the loading template file</em>.
            For example, here is a consistent location of 3 files:
          </p>
          <pre><code class="language-html">&lt;!-- in /a/b/c.html --&gt;
{% extends "../_foo.html" %}
{% include "_bar.html" %}

&lt;!-- /a/_foo.html --&gt;
...some extendable template...

&lt;!-- /a/b/_bar.html --&gt;
...some includable content...
</code></pre>
          <p>
            Note that both <code>_foo.html</code> and <code>_bar.html</code> are working files (because of the leading
            underscore), and therefore won’t be run through Jinja directly. Anything included by a Jinja template
            should almost certainly be a working file.
          </p>
          <p>
            Templating can make use of data, for example to generate lists of things, pull out into one place something
            which is used in multiple places, or just self-document the meaning of something better.
          </p>
          <p>
            AWG reads data from all TOML files (<code>*.toml</code>), combining everything into a single namespace.
            This allows the data to be kept near to where it is used. Although tempting to have separate namespaces,
            doing so from a hierarchy of such files (including multiple files in the same directory) seems overly
            complex and could even <em>increase</em> the maintenance overhead. Using meaningful names and having the
            tool check for name collisions is both practical and easy to understand.
          </p>
          <h2>
            Markdown
          </h2>
          <p>
            There are many flavours of Markdown. I have chosen to use <a href="https://commonmark.org">CommonMark</a>,
            implemented using the <a href="https://markdown-it-py.readthedocs.io">markdown-it-py</a> Python library.
          </p>
          <p>
            To allow markdown to be incorporated into the HTML, AWG adds a “filter” to the Jinja environment. Although
            an abuse of filters, it is easy to implement and convenient to use. The input to the filter is the name of
            the file which should be converted from Markdown into HTML and included in the document at that point. For
            example:
          </p>
          <pre><code class="language-html">{{ "&lt;filename&gt;.md" | markdown() }}
</code></pre>
          <p>
            As with Jinja includes/extends (see above), the path to the file is relative to the calling template.
          </p>
          <p>
            AWG also includes some useful plugins to the markdown parser.
          </p>
          <p>
            From the <a href="https://markdown-it-py.readthedocs.io">built-in markdown-it-py extensions</a>:
          </p>
          <ul>
            <li>
              <code>replacements</code> - makes it easy to include © by writing (c) etc
            </li>
            <li>
              <code>smartquotes</code> - to make better looking “quotation marks” (as opposed to "these")
            </li>
            <li>
              <code>table</code> - to support tables
            </li>
            <li>(but not <code>linkify</code>, so links need to be made explictly)
            </li>
          </ul>
          <p>
            And from <a href="https://mdit-py-plugins.readthedocs.io">mdit-py-plugins</a>:
          </p>
          <ul>
            <li>
              <code>attrs</code> and <code>attrs_block</code> - to support CSS attributes, including on spanned text
              e.g. to allow <span class="smallcaps">Smallcaps</span>
            </li>
            <li>
              <code>deflist</code> - for definition lists
            </li>
            <li>
              <code>footnotes</code> - to render footnotes like this<sup class="footnote-ref"><a href="#fn1" id=
              "fnref1">[1]</a></sup>
            </li>
            <li>
              <code>dollarmath</code> - so maths can be written in $ or $$ marks and converted into sensible HTML tags
              with escaped content
            </li>
          </ul>
          <h2>
            Computing hashes e.g. for SRI and CSP
          </h2>
          <p>
            <a href="https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity">Subresource Integrity
            (SRI)</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Guides/CSP">Content Security
            Policy (CSP)</a> both use file hashes. To make it easier to maintain these hashes, AWG adds a Jinja filter
            <code>sha("256"|"384"|"512")</code> (with a default of <code>"384"</code>) to create SHA hashes of local
            files. For example, to create SHA384 integrity attributes for SRI,
          </p>
          <pre><code class=
          "language-html">&lt;script defer src="/render-maths.js" integrity="sha384-{{ '/render-maths.js' | sha() }}"&gt;&lt;/script&gt;
</code></pre>
          <h2>
            Summary: the AWG content interface
          </h2>
          <p>
            The AWG tool recognises 3 types of file:
          </p>
          <dl>
            <dt>
              Working files
            </dt>
            <dd>
              Files used only during the build, and will be deleted from the output.
            </dd>
            <dd>
              By default, have filenames starting with an underscore (regex <code>\_.*</code>).
            </dd>
            <dt>
              Template files
            </dt>
            <dd>
              Files which will be run through Jinja for templating, replacing the original file.
            </dd>
            <dd>
              Other files may contain templating markup, but must be included from a template file to be templated.
            </dd>
            <dd>
              Are non-working files, and by default have filenames with an extension of <code>.html</code>,
              <code>.xml</code>, or <code>.txt</code>.
            </dd>
            <dt>
              Data files
            </dt>
            <dd>
              Source of the data made available for templating.
            </dd>
            <dd>
              All share the same namespace, and name clashes/re-use across data files is an error.
            </dd>
            <dd>
              Identified by files with extension <code>.toml</code>.
            </dd>
          </dl>
          <p>
            The build process is as follows:
          </p>
          <ol>
            <li>Clone the source directory afresh for every build. The source directory is never changed (although it
            is watched).
            </li>
            <li>Load all <strong>data files</strong> into a single namespace. Any name clashes (attempts to set the
            same variable more than once) is considered an error, causing the tool to abort.
            </li>
            <li>Run all <strong>template files</strong> through Jinja, producing files of the same name.
            </li>
            <li>During templating, the contents of Markdown files can be rendered into HTML through use of the
            <code>markdown()</code> Jinja filter.
            </li>
            <li>Run all HTML files (<code>*.html</code>) through <a href="http://html-tidy.org">HTML tidy</a>,
            reporting any warnings, and standardising the formatting (e.g. indentation).
            </li>
            <li>Delete all <strong>working files</strong>, and afterwards delete any leftover empty directories.
            </li>
          </ol>
          <p>
            The tool requires no particular file or directory structure, and will work (degenerately) on an empty
            source directory.
          </p>
          <p>
            <strong>Note:</strong> The HTML generated from the markdown is the point of “maximum opinion” for AWG. It
            is the only aspect of the output which is not under the complete control of the author (in the sense that
            it contains HTML tags determined by the markdown library). Some of those tags need additional CSS to style
            (such as definition lists), and code or maths excerpts need even more substantial processing. How that can
            be done and more is explained in my <a href="approach.html">content approach</a>.
          </p>
          <h1>
            How to use
          </h1>
          <h2>
            Dependencies
          </h2>
          <p>
            The dependencies are <a href="https://docs.astral.sh/uv/">uv</a> and (optionally) <a href=
            "https://www.html-tidy.org">html-tidy</a>. For example, to set things up on a Mac using <a href=
            "https://brew.sh">Homebrew</a>:
          </p>
          <pre><code class="language-bash">❯ brew install uv tidy-html5
</code></pre>
          <h2>
            Running the tool
          </h2>
          <p>
            The tool itself is a single file Python script, <a href=
            "https://github.com/tcorbettclark/tcorbettclark.github.io/blob/master/awg.py">awg.py</a>. It uses <a href=
            "https://peps.python.org/pep-0723">inline script metadata</a> to declare Python and Python package
            dependencies which <code>uv</code> can <a href=
            "https://docs.astral.sh/uv/guides/scripts/#declaring-script-dependencies">read</a>. Then due to the
            <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">shebang</a>, the tool is conveniently runnable as an
            executable, hiding all the magic of <code>uv</code> installing a valid version of Python and required
            packages in a virtualenv.
          </p>
          <pre><code class="language-console">❯ ./awg.py --help
Usage: awg.py [OPTIONS] CONTENT_DIR OUTPUT_DIR

  AWG = Agnostic Website Generator.

  CONTENT_DIR is the directory of source web contents. It is never altered.

  OUTPUT_DIR is the new directory into which the website will be built, altering files and directories as required.

  The optional certfile and keyfile will switch to serving up over HTTPS. Generate e.g. using the mkcert tool.

Options:
  -w, --working-file-regex TEXT  Regex to match working files.  [default: \_.*]
  -t, --template-extension TEXT  Extension identifying files to template with Jinja  [default: .html, .xml, .txt]
  -h, --host TEXT                Serve on this host  [default: localhost]
  -p, --port INTEGER             Serve on this port  [default: 8000]
  --certfile TEXT                Filename containing SSL certfile (needed for HTTPS)
  --keyfile TEXT                 Filename containing SSL keyfile (needed for HTTPS)
  --help                         Show this message and exit
</code></pre>
          <p>
            The two mandatory arguments are the content and output directories. Providing them results in an output
            like this:
          </p>
          <pre><code class="language-console">❯ ./awg.py example/ output/
Working files match regex: \_.*
Template files have extension(s): .html, .xml, .txt
Using content from: /Users/tcorbettclark/Projects/tcorbettclark.github.io/example
Cloned content into fresh working directory
Reading template data from: _important_points.toml
Reading template data from: _config.toml
Converted markdown from: _hello.md
Rendered template: index.html
Removed 3 working files and 0 empty directories from output directory
Html-tidy ok: index.html
Adding new file: hot-reloader.js
Adding new file: index.html
Total number of changes to files and directories: 2
Updated: /Users/tcorbettclark/Projects/tcorbettclark.github.io/output
Starting local server on http://localhost:8000
Serving files from: /Users/tcorbettclark/Projects/tcorbettclark.github.io/output
Watching for changes in: /Users/tcorbettclark/Projects/tcorbettclark.github.io/example
</code></pre>
          <p>
            The tool is now watching for changes to the source content, after which it will rebuild and notify all
            browsers subscribed for hot reloading (see below) before waiting again for more changes. Every build is a
            full clean build without any caching or incremental behaviour, avoiding penalties from complexity and
            gotchas.
          </p>
          <p>
            <strong>Hint</strong>: Content changes sometimes temporarily break the templating mechanism (for example,
            after renaming files). A simple solution is to suspend the tool with <code>ctrl-z</code>, make the changes,
            and then foreground it with <code>fg</code>. If the content changed then the site will be rebuilt and
            browser(s) told to reload.
          </p>
          <h2>
            Using HTTPS
          </h2>
          <p>
            By default AWG will serve up over HTTP. To use HTTPS one needs certificates for <code>localhost</code>
            signed by a Certificate Authority (CA) registered on your machine.
          </p>
          <p>
            The easiest approach is to use <a href="https://mkcert.dev/">mkcert</a>, e.g.
          </p>
          <pre><code class="language-bash"># Install mkcert tool
brew install mkcert

# Use to create and install a local (self-signed) CA
mkcert -install

# Use new CA to create the cert and key files for localhost
# (generates localhost.pem and localhost-key.pem in the current directory)
mkcert localhost

# Run AWG in HTTPS mode
./awg.py content/ docs/ --certfile localhost.pem --keyfile localhost-key.pem
# ...etc
</code></pre>
          <h2>
            Hot reloading
          </h2>
          <p>
            The AWG tool provides a simple websocket API to “push notify” any browsers open on a page that the source
            has changed and they should reload. This feature can be used with a small amount of javascript e.g.
            <a href="https://github.com/tcorbettclark/tcorbettclark.github.io/blob/master/content/hot-reloader.js">hot-reloader.js</a>,
            configured to load from the <code>&lt;head&gt;</code> tag:
          </p>
          <pre><code class="language-Html">&lt;html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"&gt;
    &lt;head&gt;
        ...
        &lt;script defer src="/hot-reloader.js"&gt;&lt;/script&gt;
        ...
    &lt;/head&gt;
    ...
&lt;/html&gt;
</code></pre>
          <p>
            The javascript only runs when served up over <code>localhost</code>, so is fine to leave in for production.
            Also, not using this javascript or equivalent is fine, but the browser will need to be reloaded/refreshed
            by hand after changes.
          </p>
          <h1>
            Implementation details
          </h1>
          <h2>
            Code overview
          </h2>
          <p>
            In essence there are 3 classes with orthogonal responsibilities:
          </p>
          <ul>
            <li>
              <code>Builder</code> - Build the files by applying templates using data from TOML.
            </li>
            <li>
              <code>Watcher</code> - Watch for file changes.
            </li>
            <li>
              <code>Server</code> - Serve up the content over http(s) and the simple hot reloader protocol over a
              websocket.
            </li>
          </ul>
          <p>
            The Watcher and Server are both async; the Builder is synchronous. The main loop is clean (simplified
            slightly to show approach):
          </p>
          <pre><code class=
          "language-Python">builder = Builder(content_dir, output_dir, working_file_regex, template_extensions)
watcher = Watcher(content_dir)
server = Server(host, port, output_dir, certfile, keyfile)

builder.rebuild()
await watcher.start()
await server.start()
try:
    while True:
        await watcher.wait_for_change()
        if builder.rebuild():
            await server.signal_hot_reloaders()
except asyncio.CancelledError:
    await watcher.stop()
    await server.stop()
    builder.cleanup()
    log("Bye")
</code></pre>
          <p>
            The entire tool is a single file: <a href=
            "https://github.com/tcorbettclark/tcorbettclark.github.io/blob/master/awg.py">awg.py</a>. About half of it
            is just logging what it is doing.
          </p>
          <h2>
            Hot reloading
          </h2>
          <p>
            In theory, hot reloading is simple:
          </p>
          <ul>
            <li>use a <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket">websocket</a> to notify a
            small piece of javascript running in the browser that it should reload the page.
            </li>
          </ul>
          <p>
            In practice, there are some complications:
          </p>
          <ul>
            <li>making it obvious to the user when the hot reloader is not running (e.g. after stopping/starting AWG,
            for whatever reason);
            </li>
            <li>reconnecting after the page has been reloaded (prompted either by the hot reloader or by the user);
            </li>
            <li>handling <a href="https://developer.chrome.com/docs/web-platform/page-lifecycle-api">page lifecycle</a>
            complexities such as history navigation, browsers putting tabs to sleep, etc;
            </li>
            <li>discouraging browsers from closing websockets due to inactivity;
            </li>
            <li>dealing with the fact that the WebSocket javascript object is asynchronous.
            </li>
          </ul>
          <p>
            The protocol consists of two messages:
          </p>
          <ul>
            <li>the server can send connected clients a <code>reload</code> message;
            </li>
            <li>connected clients can send the server a <code>keep-alive-ping</code> message.
            </li>
          </ul>
          <p>
            For the failure handling strategy, note first that opening a socket with <code>new WebSocket()</code> is
            asynchronous. It does not raise an exception on failure to connect. Also, the <code>onerror</code> signal
            can occur even under normal use, e.g. if the user navigates browser history with forward/back buttons, or
            if the browser suspends/resumes the page.
          </p>
          <p>
            The most robust approach seems to be to use the <code>onclose</code> signal, differentiating between
            whether or not the connection has ever opened ok.
          </p>
          <ul>
            <li>If <strong>yes</strong>, try to restart it (this could happen after visibility change or freeze/resume
            cycle).
            </li>
            <li>If <strong>no</strong>, then there was a bigger problem, so show a blocking alert to the user. After
            that blocking alert is dismissed, reload the whole page (and hence start the cycle again).
            </li>
          </ul>
          <p>
            With that all in mind, the javascript is clean:
          </p>
          <pre><code class="language-Javascript">function start_hot_reloader() {
  const host = window.location.host;
  const protocol = window.location.protocol == "https:" ? "wss" : "ws";
  const ws = new WebSocket(`${protocol}://${host}/ws`);

  ws.onclose = function close_without_having_opened() {
    // We will replace this function after successfully opening the connection.
    // Hence if we reach here, the websocket closed without ever having opened
    // and so failed to connect/open in the first place.
    alert(
      "Hot reloader failed. Is the local server running?\n\nClose this window to try again.",
    );
    // Best to reload because the server content may have changed in the interim.
    window.location.reload(true);
  };

  ws.onopen = function on_open() {
    console.log("Hot reloader: websocket connection open");
    // Start a keep-alive pinger to encourage the browser to keep the websocket open.
    var pinger_id = setInterval(() =&gt; {
      ws.send("keep-alive-ping");
    }, 5000);
    // Now that we have opened the connection, replace the onclose function.
    ws.onclose = function close_after_opened_ok() {
      clearInterval(pinger_id);
      console.log("Hot reloader: websocket connection closed");
      setTimeout(start_hot_reloader, 50);
    };
  };

  ws.onmessage = function on_message(event) {
    if (event.data == "reload") {
      window.location.reload(true);
    } else {
      console.log(`Hot reloader websocket received: {event.data}`);
    }
  };
}

addEventListener("load", (event) =&gt; {
  if (window.location.hostname == "localhost") {
    start_hot_reloader();
  }
});
</code></pre>
          <h2>
            Tool development
          </h2>
          <p>
            Used in the recommended way described above, <code>uv</code> creates a disposable but cached virtualenv in
            which to install the dependencies and run the tool.
          </p>
          <p>
            During any development of the tool, it is helpful to have a consistent virtual env in <code>.venv</code>
            which editors can use for appropriate checking and code completion etc with the installed libraries. This
            can be achieved as follows:
          </p>
          <pre><code class="language-bash"># Create virtualenv in .venv
uv venv

# Activate it
source .venv/bin/activate.fish

# Run tool with the active virtualenv rather than create a new/hidden one.
uv run --active --script awg.py ./content/ ./docs/

# Add/remove packages, updating the metadata in both the tool and the active virtualenv.
uv add --active --script awg.py &lt;package&gt;
uv remove --active --script awg.py &lt;package&gt;

# Upgrade packages in the development virtualenv (does not change awg.py)
uv sync --upgrade --active --script awg.py

# View packages in active virtualenv
# NB uv tree uses hidden cached virtualenv, so best to use pip subcommand.
uv pip list
uv pip tree
</code></pre>
          <hr class="footnotes-sep" />
          <section class="footnotes">
            <ol class="footnotes-list">
              <li id="fn1" class="footnote-item">
                <p>
                  Demo footnote. <a href="#fnref1" class="footnote-backref">↩︎</a>
                </p>
              </li>
            </ol>
          </section>
        </div>
      </div>
    </section>
    <footer class="footer pt-4 pb-4">
      <div class="has-text-centered">
        <p>
          <span class="icon-text"><span class="icon"><i class="fa-regular fa-copyright"></i></span> <span>Timothy
          Corbett-Clark, 2025</span></span>
        </p>
        <p>
          Website <a href="/building-this-website/index.html">source</a>.
        </p>
      </div>
    </footer>
  </body>
</html>
