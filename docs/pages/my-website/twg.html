<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
  <head>
    <meta name="generator" content="HTML Tidy for HTML5 for Apple macOS version 5.8.0" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Timothy Corbett-Clark" />
    <meta name="description" content="Personal website of Dr Timothy Corbett-Clark" />
    <title>
      Dr Timothy Corbett-Clark
    </title>
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png" />
    <link rel="icon" type="image/x-icon" href="/favicon/favicon.ico" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css" integrity=
    "sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP" crossorigin="anonymous" />
    <link rel="stylesheet" href=
    "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/atom-one-dark.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css" />
    <link rel="stylesheet" type="text/css" href="/main.css" />
    <script src="https://kit.fontawesome.com/39e34b83e1.js" crossorigin="anonymous"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js" integrity=
    "sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6" crossorigin="anonymous"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"
    crossorigin="anonymous"></script>
    <script defer="defer" src="/hot_reloader.js" async="async"></script>
    <script defer="defer" src="/render_maths.js"></script>
    <script defer="defer" src="/render_code.js"></script>
  </head>
  <body class="draft-watermark">
    <header class="hero is-small is-primary">
      <div class="hero-body">
        <p class="title">
          Dr Timothy Corbett‑Clark
        </p>
        <p class="subtitle">
          CTO, Researcher, Developer
        </p>
      </div>
    </header>
    <section class="m-4">
      <span class="tag"><a href="/wip.html"><i class="fa-solid fa-bug"></i> wip</a></span> <span class="tag"><a href=
      "/index.html"><i class="fa-solid fa-arrow-up"></i> Back to home</a></span>
    </section>
    <section class="section pt-0">
      <div class="box has-background-primary-95">
        <div class="content">
          <h1>
            Tim’s Web Generator (TWG) tool
          </h1>
          <h2>
            Features / anti-features
          </h2>
          <p>
            Assuming a willingness to understand the necessary web technologies, why not create static websites <em>by
            hand</em>? The main problems are around inefficient repetition and cumbersome syntax. For example,
          </p>
          <ul>
            <li>copy-and-paste maintenance of the same content e.g. in headers and footers;
            </li>
            <li>copy-and-paste maintenance of the same formatting/styling tags around repeated lists of things;
            </li>
            <li>using a verbose syntax like HTML when wanting to focus purely on content.
            </li>
          </ul>
          <p>
            These pain points can be ameliorated by using a markup language (like <a href=
            "https://commonmark.org">markdown</a>), templating (e.g. with <a href=
            "https://jinja.palletsprojects.com/en/stable/">Jinja2</a>), and writing data/metadata in a data-oriented
            syntax (such as <a href="https://toml.io/">TOML</a>).
          </p>
          <p>
            My tool makes it easier to create a static website of the usual HTML, CSS, and Javascript files (plus a few
            others such as the manifest.json, robots.txt, and sitemap.xml). <strong>It is a scaffolding tool with no
            fundamental opinion about these web files</strong>.
          </p>
          <p>
            The essential features are:
          </p>
          <ol>
            <li>Converting Markdown into HTML (to allow content to be written more easily).
            </li>
            <li>Templating using Jinja2 (most obviously to make it easier to produce repetative HTML).
            </li>
            <li>Reading template data from TOML files (to pass to Jinja2).
            </li>
            <li>Validating and prettifying all final HTML by running through <a href="http://html-tidy.org">HTML
            tidy</a> (if available).
            </li>
          </ol>
          <p>
            Then, to create a fast iterative loop:
          </p>
          <ol start="5">
            <li>Serving up content on a local http webserver (for review during development).
            </li>
            <li>Watching for source file changes and rebuilding automatically.
            </li>
            <li>Notifying browser(s) of new builds (<em>e.g.</em> to trigger a “hot reload”).
            </li>
          </ol>
          <p>
            Note the absence of themes, plugins, blog posts, tags, articles, Atom or RSS feeds etc. Many of these are
            easy to achieve using the tool’s machinery without explicit native support.
          </p>
          <h2>
            Zero config
          </h2>
          <p>
            With the exception of a few command line options to tell the tool where to find the content and put the
            output, <strong>there is no configuration</strong>. There are no required files or directory structures,
            and so (degenerately) <strong>the tool will run fine on an empty directory</strong>. There is a simple
            <code>example/</code> content directory in the <a href=
            "https://github.com/tcorbettclark/tcorbettclark.github.io">GitHub repository</a> to demo some of the
            functionality and provide a learning sandpit to play in.
          </p>
          <h2>
            Subtractive approach
          </h2>
          <p>
            Instead of copying and creating files and directories from various sources and processes, the tool takes a
            “subtractive” approach. The build process starts by cloning a given content directory into a new output
            directory. After running the build process, all “working files” are deleted from this output directory. By
            default, <em>working files</em> are identified as filenames starting with an underscore and <em>template
            files</em> as having an extension of <code>.html</code>, <code>.xml</code>, and <code>.txt</code>.
          </p>
          <p>
            In addition to removing mystery around how an output is generated, this approach allows maintenance effort
            to be reduced by grouping related content. For example, all HTML, Markdown, template data, Javascript,
            <em>etc</em> relating to a particular page or section of the site <strong>can be kept together in the same
            directory</strong>. This localisation of content means that after changes, removal, or replacement, the
            chances of things being left behind afterwards are much reduced.
          </p>
          <p>
            Note however that due to the tool’s lack of opinion in this regard, content can still be grouped by type in
            the traditional fashion if desired (all the javascript in one directory, all the CSS in another,
            <em>etc</em>). Or a mixed by-purpose/by-type strategy used. Regardless, the files and structure is all
            explicit and visible.
          </p>
          <h2>
            Dependencies
          </h2>
          <p>
            The dependencies are <a href="https://docs.astral.sh/uv/">uv</a> and (optionally) <a href=
            "https://www.html-tidy.org">html-tidy</a>. For example, to set things up on a Mac using <a href=
            "https://brew.sh">Homebrew</a>:
          </p>
          <pre><code class="language-bash">❯ brew install tidy-html5 uv
</code></pre>
          <h2>
            Running the tool
          </h2>
          <p>
            The tool itself is a single file Python script called <code>twg.py</code>. It uses <a href=
            "https://peps.python.org/pep-0723">inline script metadata</a> to declare Python and Python package
            dependencies which <code>uv</code> can <a href=
            "https://docs.astral.sh/uv/guides/scripts/#declaring-script-dependencies">read</a>. Then due to the
            <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">shebang</a>, the tool is conveniently runnable as an
            executable, hiding all the magic of <code>uv</code> installing a valid version of Python and required
            packages in a virtualenv.
          </p>
          <pre><code class="language-console">❯ ./twg.py --help
Usage: twg.py [OPTIONS] CONTENT_DIR OUTPUT_DIR

  TWG = Tim's Website Generator.

  CONTENT_DIR is the directory of source web contents. It is never altered.

  OUTPUT_DIR is the new directory into which the website will be built. It is destroyed before every build.

Options:
  -w, --working-file-regex TEXT  Regex to match working files.  [default: \_.*]
  -t, --template-extension TEXT  Extension identifying files to template with Jinja2  [default: .html, .xml, .txt]
  -h, --host TEXT                Serve on this host  [default: localhost]
  -p, --port INTEGER             Serve on this port  [default: 8000]
  --help                         Show this message and exit.
</code></pre>
          <p>
            The two mandatory arguments are the content and output directories. Providing them results in something
            like this:
          </p>
          <pre><code class="language-console">❯ ./twg.py example/ output/
Working files match regex: \_.*
Template files have extension(s): .html, .xml, .txt
Using content from: /Users/tcorbettclark/Projects/tcorbettclark.github.io/example (example)
Cloned content into fresh output directory: /Users/tcorbettclark/Projects/tcorbettclark.github.io/output (output)
Reading template data from: output/_important_points.toml
Reading template data from: output/_config.toml
Converted markdown from: output/_hello.md
Rendered template: output/index.html
Removed 3 working files and 0 empty directories from output directory
Html-tidy ok: output/index.html
Rebuilt all files in: output
Starting local server on http://localhost:8000
Serving files from: output
Watching for changes in: example
</code></pre>
          <p>
            The tool is now watching for changes to the source content, after which it will rebuild and notify any
            browsers to trigger a reload before waiting again for more changes. Every build is a full clean build
            without any caching or incremental behaviour, avoiding penalties from complexity and gotchas.
          </p>
          <p>
            <strong>Hint</strong>: Content changes sometimes temporarily break the templating mechanism (for example,
            after renaming files). A simple solution is to suspend the tool with <code>ctrl-z</code>, make the changes,
            and then foreground it with <code>fg</code>. If the content changed then the site will be rebuilt and
            browser(s) told to reload.
          </p>
          <h2>
            Template data
          </h2>
          <p>
            TODO: explain collecting TOML, and detecting conflicts.
          </p>
          <p>
            Re toml data sharing same namespace, point out that trivial to add a namespace in toml
          </p>
          <h2>
            Jinja2 templating
          </h2>
          <p>
            TODO: explain Relative paths for localisation
          </p>
          <p>
            TODO: List Jinja2 options used.
          </p>
          <h2>
            Markdown
          </h2>
          <p>
            TODO: explain how to call from Jinja2 templates. TODO: explain why CommonMarkdown TODO: explain plugins
          </p>
          <p>
            Refer to example directory.
          </p>
          <h2>
            Indentation management
          </h2>
          <p>
            Indentation - for clarity in content view for easier writing and maintaining. But also want properly
            formatted output. Hence tidy.
          </p>
          <p>
            Don’t attempt to generate nicely indented HTML. Use Tidy instead. But write source files neatly for easy
            maintenance - properly indented for readability as source. This is also why files are of one language type
            - so that editors can use the corresponding language mode (LSP).
          </p>
          <h2>
            Hot Reloader fun
          </h2>
          <p>
            https://developer.chrome.com/docs/web-platform/page-lifecycle-api
          </p>
          <p>
            Need to be able to handle: 1 Browser refresh/reload by hand 1 Browser refresh/reload triggered from server
            following change 1 Navigating away to a page on another site which exists 1 Navigating away to a page on
            another site which does not exist (404) 1 Navigating to another page on my site which exists 1 Navigating
            to another page on my site which does not exist (404) 1 Back button 1 Forward button 1 Close tab 1 Close
            browser
          </p>
          <p>
            Tools: 1 Server detecting connection has dropped 1 Client detecting connection has dropped 1 Client side
            localstorage 1 Browser detecting a reload/refresh is about to happen event beforeunload event pagehide and
            pageshow event visibilitychange event freeze and resume
          </p>
          <p>
            See https://developer.chrome.com/docs/web-platform/page-lifecycle-api
          </p>
          <p>
            new WebSocket does not raise an exception on failure to connect because it is asynchronous. onerror can
            occur even under normal use, e.g. using the browser history forward/back buttons, and having the page
            freeze/resume etc.
          </p>
          <p>
            Most robust approach is to trap onclose and differentiate between whether the connection has ever opened
            ok. If it has, try to restart it (this could happen after visibility change or freeze/resume cycle); if it
            hasn’t opened ok then there was a bigger problem, so we show a blocking alert to the user, after which we
            reload the whole page (and hence start the cycle again).
          </p>
          <h2>
            Code overview
          </h2>
          <p>
            TODO: include simplified snippets.
          </p>
          <p>
            For example
          </p>
          <pre><code class="language-Python">class Watcher:
    def __init__(self, directory):
        self.directory = directory
        self._change_event = asyncio.Event()

    async def _start(self):
        log("Watching for changes in: {}", self.directory)
        async for changes in watchfiles.awatch(self.directory):
            for change, filename in list(changes):
                filename = pathlib.Path(filename)
                if change == watchfiles.Change.added:
                    log("Noticed file added: {}", filename)
                elif change == watchfiles.Change.deleted:
                    log("Noticed file deleted: {}", filename)
                elif change == watchfiles.Change.modified:
                    log("Noticed file modified: {}", filename)
            self._change_event.set()

    async def start(self):
        return asyncio.create_task(self._start())

    async def wait_for_change(self):
        await self._change_event.wait()
        self._change_event.clear()
</code></pre>
          <h2>
            Tool development
          </h2>
          <p>
            So that your editor can pick up the scripts’ virtual enviroment, symlink <code>.venv</code> e.g. something
            like:
          </p>
          <p>
            ???
          </p>
          <pre><code class=
          "language-bash">ln -s /Users/tcorbettclark/.cache/uv/environments-v2/run-f69dfe2b9a396a65 .venv
</code></pre>
          <p>
            To add or remove packages needed by <code>twg.py</code>,
          </p>
          <pre><code class="language-bash">uv add --script twg.py &lt;package&gt;
uv remove --script twg.py &lt;package&gt;
</code></pre>
        </div>
      </div>
    </section>
    <footer class="footer pt-4 pb-4">
      <div class="has-text-centered">
        <p>
          <span class="icon-text"><span class="icon"><i class="fa-regular fa-copyright"></i></span> <span>Timothy
          Corbett-Clark, 2025</span></span>
        </p>
        <p>
          Website (<a href="https://github.com/tcorbettclark/tcorbettclark.github.io" target="_blank">src</a>) built
          using <a href="https://www.python.org/" target="_blank">Python</a>, <a href=
          "https://jinja.palletsprojects.com/" target="_blank">Jinja2</a>, <a href=
          "https://daringfireball.net/projects/markdown/" target="_blank">Markdown</a>, and <a href="https://bulma.io/"
          target="_blank">Bulma</a>.
        </p>
      </div>
    </footer>
  </body>
</html>
